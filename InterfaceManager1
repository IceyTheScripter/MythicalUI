-- ========================
-- Fixed Mythical InterfaceManager
-- ========================
local HttpService = game:GetService("HttpService")

local InterfaceManager = {} do
    InterfaceManager.Folder = "MythicalScriptHub"
    InterfaceManager.Settings = {
        Theme = "Dark", -- Set your default theme here
        MenuKeybind = "LeftControl"
    }
    InterfaceManager.Library = nil

    function InterfaceManager:SetFolder(folder)
        self.Folder = folder
        self:BuildFolderTree()
    end

    function InterfaceManager:SetLibrary(library)
        self.Library = library
    end

    function InterfaceManager:BuildFolderTree()
        if not isfolder(self.Folder) then makefolder(self.Folder) end
        local interfacePath = self.Folder .. "/interface"
        if not isfolder(interfacePath) then makefolder(interfacePath) end
    end

    function InterfaceManager:SaveSettings()
        -- Saves to interface folder
        writefile(self.Folder .. "/interface/settings.json", HttpService:JSONEncode(self.Settings))
    end

    function InterfaceManager:LoadSettings()
        local path = self.Folder .. "/interface/settings.json"
        if isfile(path) then
            local data = readfile(path)
            local success, decoded = pcall(HttpService.JSONDecode, HttpService, data)
            if success and decoded then
                for key, value in next, decoded do
                    self.Settings[key] = value
                end
            end
        end
        
        -- Apply the loaded theme immediately
        if self.Library and self.Library.SetTheme then
            self.Library:SetTheme(self.Settings.Theme)
        end
    end

    function InterfaceManager:BuildInterfaceSection(tab)
        assert(self.Library, "InterfaceManager.Library must be set!")
        self:LoadSettings()

        -- Create a section to keep it clean (like Fluent does)
        local section = tab:AddSection("Interface Settings")

        -- Theme Dropdown
        -- We check for Library.Themes (table) OR Library:GetThemes() (function)
        local themeList = self.Library.Themes or (self.Library.GetThemes and self.Library:GetThemes()) or {"Dark", "Light"}
        
        local themeDropdown = section:AddDropdown("InterfaceTheme", {
            Title = "Theme",
            Description = "Changes the UI color palette",
            Values = themeList,
            Default = self.Settings.Theme,
            Callback = function(value)
                if self.Library.SetTheme then
                    self.Library:SetTheme(value)
                    self.Settings.Theme = value
                    self:SaveSettings()
                end
            end
        })

        themeDropdown:SetValue(self.Settings.Theme)

        -- Menu Keybind (Crucial for closing/opening the UI)
        local MenuKeybind = section:AddKeybind("MenuKeybind", { 
            Title = "Minimize Bind", 
            Default = self.Settings.MenuKeybind 
        })

        MenuKeybind:OnChanged(function()
            self.Settings.MenuKeybind = MenuKeybind.Value
            self:SaveSettings()
        end)

        -- Sync the library's internal bind with the manager
        if self.Library.MinimizeKeybind then
            self.Library.MinimizeKeybind = MenuKeybind
        end
    end
end

return InterfaceManager
