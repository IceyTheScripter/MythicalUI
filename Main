-- MYTHICAL UI LIBRARY FIXED
local MythicalUI = {}
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")

-- THEME
local Themes = {
    {
        name = "Purple Mystic",
        primary = Color3.fromRGB(138, 43, 226),
        secondary = Color3.fromRGB(186, 85, 211),
        background = Color3.fromRGB(15, 15, 20),
        topbar = Color3.fromRGB(20, 20, 28),
        element = Color3.fromRGB(25, 25, 35),
        text = Color3.fromRGB(255, 255, 255),
        textDim = Color3.fromRGB(180, 180, 200),
        accent = Color3.fromRGB(138, 43, 226),
        particleColor = Color3.fromRGB(138, 43, 226)
    }
}
local currentTheme = Themes[1]

-- SOUND UTILITY
local function playSound(soundId, volume, pitch)
    local sound = Instance.new("Sound")
    sound.SoundId = soundId
    sound.Volume = volume or 0.5
    sound.PlaybackSpeed = pitch or 1
    sound.Parent = game:GetService("SoundService")
    sound:Play()
    game:GetService("Debris"):AddItem(sound, 2)
end

local function tween(obj, props, duration, style, dir)
    return TweenService:Create(obj, TweenInfo.new(duration or 0.3, style or Enum.EasingStyle.Quad, dir or Enum.EasingDirection.Out), props)
end

-- CREATE WINDOW
function MythicalUI:CreateWindow(config)
    local Window = {}
    Window.Tabs = {}
    Window.CurrentTab = nil

    -- ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "MythicalUI"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    if gethui then screenGui.Parent = gethui()
    elseif syn and syn.protect_gui then syn.protect_gui(screenGui); screenGui.Parent = CoreGui
    else screenGui.Parent = CoreGui end

    -- Main Frame
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    mainFrame.Size = UDim2.fromScale(0.45, 0.65)
    mainFrame.BackgroundColor3 = currentTheme.background
    mainFrame.BorderSizePixel = 0
    mainFrame.ClipsDescendants = true
    mainFrame.Parent = screenGui

    -- Corner + Stroke
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = mainFrame
    local stroke = Instance.new("UIStroke")
    stroke.Color = currentTheme.primary
    stroke.Thickness = 2
    stroke.Transparency = 0.5
    stroke.Parent = mainFrame

    -- Top Bar
    local topBar = Instance.new("Frame")
    topBar.Name = "TopBar"
    topBar.Size = UDim2.new(1, 0, 0, 45)
    topBar.BackgroundColor3 = currentTheme.topbar
    topBar.BorderSizePixel = 0
    topBar.ZIndex = 5
    topBar.Parent = mainFrame
    local topCorner = Instance.new("UICorner")
    topCorner.CornerRadius = UDim.new(0, 12)
    topCorner.Parent = topBar

    -- Title
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(0, 200, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = config.Title or "Mythical UI"
    title.TextColor3 = currentTheme.text
    title.TextSize = 18
    title.Font = Enum.Font.GothamBold
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.ZIndex = 6
    title.Parent = topBar

    -- Subtitle
    local subtitle = Instance.new("TextLabel")
    subtitle.Size = UDim2.new(0, 100, 1, 0)
    subtitle.Position = UDim2.new(0, 220, 0, 0)
    subtitle.BackgroundTransparency = 1
    subtitle.Text = config.SubTitle or "v1.0"
    subtitle.TextColor3 = currentTheme.textDim
    subtitle.TextSize = 14
    subtitle.Font = Enum.Font.Gotham
    subtitle.TextXAlignment = Enum.TextXAlignment.Left
    subtitle.ZIndex = 6
    subtitle.Parent = topBar

    -- Close & Minimize
    local function createTopButton(text, pos, callback)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, 35, 0, 35)
        btn.Position = UDim2.new(1, pos, 0.5, 0)
        btn.AnchorPoint = Vector2.new(0, 0.5)
        btn.BackgroundColor3 = currentTheme.element
        btn.BorderSizePixel = 0
        btn.Text = text
        btn.TextColor3 = currentTheme.text
        btn.Font = Enum.Font.GothamBold
        btn.TextSize = 24
        btn.ZIndex = 6
        btn.Parent = topBar
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 8)
        corner.Parent = btn
        btn.MouseButton1Click:Connect(callback)
        btn.MouseEnter:Connect(function() tween(btn, {BackgroundColor3=currentTheme.primary},0.2):Play() end)
        btn.MouseLeave:Connect(function() tween(btn, {BackgroundColor3=currentTheme.element},0.2):Play() end)
        return btn
    end

    local isMinimized = false
    local origSize = mainFrame.Size
    local minimizeBtn = createTopButton("−", -80, function()
        isMinimized = not isMinimized
        if isMinimized then
            tween(mainFrame, {Size=UDim2.new(0,240,0,45)},0.3):Play()
        else
            tween(mainFrame, {Size=origSize},0.3):Play()
        end
    end)

    local closeBtn = createTopButton("×", -40, function()
        tween(mainFrame, {Size=UDim2.new(0,0,0,0)},0.3):Play()
        task.wait(0.3)
        screenGui:Destroy()
    end)

    -- Dragging
    local dragging, dragStart, startPos
    topBar.InputBegan:Connect(function(input)
        if input.UserInputType==Enum.UserInputType.MouseButton1 then
            dragging=true
            dragStart=input.Position
            startPos=mainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState==Enum.UserInputState.End then
                    dragging=false
                end
            end)
        end
    end)
    topBar.InputChanged:Connect(function(input)
        if input.UserInputType==Enum.UserInputType.MouseMovement then
            dragInput=input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType==Enum.UserInputType.MouseMovement then
            local delta=input.Position - dragStart
            mainFrame.Position=UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)

    -- Tab container
    local tabContainer = Instance.new("Frame")
    tabContainer.Size=UDim2.new(0,160,1,-50)
    tabContainer.Position=UDim2.new(0,5,0,50)
    tabContainer.BackgroundTransparency=1
    tabContainer.Parent=mainFrame
    local tabLayout = Instance.new("UIListLayout")
    tabLayout.Padding = UDim.new(0,5)
    tabLayout.Parent = tabContainer

    local contentContainer = Instance.new("Frame")
    contentContainer.Size=UDim2.new(1,-175,1,-60)
    contentContainer.Position=UDim2.new(0,165,0,55)
    contentContainer.BackgroundTransparency=1
    contentContainer.Parent=mainFrame

    -- Add tab
    function Window:AddTab(tabConfig)
        local Tab = {Name=tabConfig.Title or "Tab"}
        local btn = Instance.new("TextButton")
        btn.Size=UDim2.new(1,0,0,40)
        btn.BackgroundColor3=currentTheme.element
        btn.Text="  "..Tab.Name
        btn.TextColor3=currentTheme.textDim
        btn.TextXAlignment=Enum.TextXAlignment.Left
        btn.Parent=tabContainer
        local corner = Instance.new("UICorner")
        corner.CornerRadius=UDim.new(0,8)
        corner.Parent=btn

        local content = Instance.new("ScrollingFrame")
        content.Size=UDim2.new(1,0,1,0)
        content.BackgroundTransparency=1
        content.Visible=false
        content.Parent=contentContainer
        local layout = Instance.new("UIListLayout")
        layout.Parent=content
        layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            content.CanvasSize=UDim2.new(0,0,0,layout.AbsoluteContentSize.Y)
        end)

        btn.MouseButton1Click:Connect(function()
            for _, t in pairs(Window.Tabs) do
                t.Button.BackgroundColor3=currentTheme.element
                t.Button.TextColor3=currentTheme.textDim
                t.Content.Visible=false
            end
            btn.BackgroundColor3=currentTheme.primary
            btn.TextColor3=currentTheme.text
            content.Visible=true
            Window.CurrentTab=Tab.Name
        end)

        Window.Tabs[Tab.Name]={Button=btn,Content=content}
        return {
            AddButton=function(_,cfg)
                local b=Instance.new("TextButton")
                b.Size=UDim2.new(1,0,0,40)
                b.BackgroundColor3=currentTheme.element
                b.Text=cfg.Title or "Button"
                b.TextColor3=currentTheme.text
                b.Parent=content
                b.MouseButton1Click:Connect(function()
                    if cfg.Callback then cfg.Callback() end
                end)
                return b
            end
        }
    end

    return Window
end

return MythicalUI
