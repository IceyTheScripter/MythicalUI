-- ========================
-- Mythical SaveManager
-- ========================
local HttpService = game:GetService("HttpService")

local SaveManager = {} do
    SaveManager.Folder = "MythicalScriptHub/game-configs"
    SaveManager.Settings = {}
    SaveManager.OptionsRegistry = {} -- Stores all UI elements
    SaveManager.IgnoreThemeSettings = false
    SaveManager.IgnoreIndexes = {}
    SaveManager.Library = nil

    -- Set the folder for configs
    function SaveManager:SetFolder(folder)
        self.Folder = folder
        self:BuildFolderTree()
    end

    -- Connect the UI library
    function SaveManager:SetLibrary(library)
        self.Library = library
    end

    -- Ignore theme settings in save
    function SaveManager:IgnoreThemeSettings()
        self.IgnoreThemeSettings = true
    end

    function SaveManager:SetIgnoreIndexes(indexes)
        self.IgnoreIndexes = indexes
    end

    -- Make folder structure
    function SaveManager:BuildFolderTree()
        local paths = {}
        local parts = self.Folder:split("/")
        for idx = 1, #parts do
            table.insert(paths, table.concat(parts, "/", 1, idx))
        end
        table.insert(paths, self.Folder .. "/configs")

        for _, path in next, paths do
            if not isfolder(path) then
                makefolder(path)
            end
        end
    end

    -- Register a UI element for saving/loading
    function SaveManager:RegisterOption(key, element)
        self.OptionsRegistry[key] = element
    end

    -- Save all registered options
    function SaveManager:SaveSettings()
        local saveTable = {}
        for key, element in next, self.OptionsRegistry do
            if not table.find(self.IgnoreIndexes, key) then
                if element.Type == "Toggle" or element.Type == "Slider" or element.Type == "Dropdown" or element.Type == "Input" then
                    saveTable[key] = element:GetValue()
                elseif element.Type == "Colorpicker" then
                    saveTable[key] = {
                        Color = element:GetValue(),
                        Transparency = element.Transparency or 0
                    }
                end
            end
        end

        if self.IgnoreThemeSettings and saveTable.Theme then
            saveTable.Theme = nil
        end

        writefile(self.Folder .. "/config.json", HttpService:JSONEncode(saveTable))
    end

    -- Load all registered options
    function SaveManager:LoadSettings()
        local path = self.Folder .. "/config.json"
        if isfile(path) then
            local data = readfile(path)
            local success, decoded = pcall(HttpService.JSONDecode, HttpService, data)
            if success and decoded then
                for key, value in next, decoded do
                    local element = self.OptionsRegistry[key]
                    if element then
                        if element.Type == "Colorpicker" then
                            element:SetValueRGB(value.Color)
                            if value.Transparency then
                                element.Transparency = value.Transparency
                            end
                        else
                            element:SetValue(value)
                        end
                    end
                    self.Settings[key] = value
                end
            end
        end
    end

    -- Build Settings tab automatically
    function SaveManager:BuildConfigSection(tab)
        assert(self.Library, "SaveManager.Library must be set!")

        local buttons = {
            {Title = "Save Config", Callback = function()
                self:SaveSettings()
                self.Library:Notify({
                    Title = "Config Saved",
                    Content = "Your settings have been saved!",
                    Duration = 3
                })
            end},

            {Title = "Load Config", Callback = function()
                self:LoadSettings()
                self.Library:Notify({
                    Title = "Config Loaded",
                    Content = "Your settings have been loaded!",
                    Duration = 3
                })
            end},

            {Title = "Reset to Defaults", Callback = function()
                for key, element in next, self.OptionsRegistry do
                    element:SetValue(element.Default)
                end
                self:SaveSettings()
                self.Library:Notify({
                    Title = "Reset",
                    Content = "Settings reset to defaults!",
                    Duration = 3
                })
            end}
        }

        for _, btn in next, buttons do
            tab:AddButton(btn)
        end
    end

    -- Auto-load config at startup
    function SaveManager:LoadAutoloadConfig()
        self:LoadSettings()
    end
end

return SaveManager
