local httpService = game:GetService("HttpService")

local SaveManager = {} do
	SaveManager.Folder = "MythicalScriptHub/game-configs"
    SaveManager.Settings = {}
    SaveManager.IgnoreThemeSettings = false
    SaveManager.IgnoreIndexes = {}
    SaveManager.Options = {}

    function SaveManager:SetFolder(folder)
		self.Folder = folder
		self:BuildFolderTree()
	end

    function SaveManager:SetLibrary(library)
		self.Library = library
	end

    function SaveManager:IgnoreThemeSettings()
        self.IgnoreThemeSettings = true
    end

    function SaveManager:SetIgnoreIndexes(indexes)
        self.IgnoreIndexes = indexes
    end

    function SaveManager:BuildFolderTree()
		local paths = {}
		local parts = self.Folder:split("/")
		for idx = 1, #parts do
			paths[#paths + 1] = table.concat(parts, "/", 1, idx)
		end
		table.insert(paths, self.Folder)
		table.insert(paths, self.Folder .. "/configs")

		for i = 1, #paths do
			local str = paths[i]
			if not isfolder(str) then
				makefolder(str)
			end
		end
	end

    function SaveManager:SaveSettings()
        writefile(self.Folder .. "/config.json", httpService:JSONEncode(SaveManager.Settings))
    end

    function SaveManager:LoadSettings()
        local path = self.Folder .. "/config.json"
        if isfile(path) then
            local data = readfile(path)
            local success, decoded = pcall(httpService.JSONDecode, httpService, data)

            if success then
                for i, v in next, decoded do
                    SaveManager.Settings[i] = v
                end
            end
        end
    end

    function SaveManager:BuildConfigSection(tab)
        assert(self.Library, "Must set SaveManager.Library")
        
        SaveManager:LoadSettings()
        
        -- Save Config Button
        tab:AddButton({
            Title = "Save Config",
            Description = "Save your current settings",
            Callback = function()
                SaveManager:SaveSettings()
                self.Library:Notify({
                    Title = "Config Saved",
                    Content = "Your settings have been saved!",
                    Duration = 3
                })
            end
        })

        -- Load Config Button
        tab:AddButton({
            Title = "Load Config",
            Description = "Load your saved settings",
            Callback = function()
                SaveManager:LoadSettings()
                self.Library:Notify({
                    Title = "Config Loaded",
                    Content = "Your settings have been loaded!",
                    Duration = 3
                })
            end
        })

        -- Reset to Defaults Button
        tab:AddButton({
            Title = "Reset to Defaults",
            Description = "Reset all settings to default",
            Callback = function()
                SaveManager.Settings = {}
                SaveManager:SaveSettings()
                self.Library:Notify({
                    Title = "Reset",
                    Content = "Settings have been reset!",
                    Duration = 3
                })
            end
        })
    end

    function SaveManager:LoadAutoloadConfig()
        SaveManager:LoadSettings()
    end
end

return SaveManager
