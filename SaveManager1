-- ========================
-- Fixed Mythical SaveManager
-- ========================
local HttpService = game:GetService("HttpService")

local SaveManager = {} do
    SaveManager.Folder = "MythicalScriptHub"
    SaveManager.Settings = {}
    SaveManager.Options = {} -- This is the magic table
    SaveManager.IgnoreThemeSettings = false
    SaveManager.IgnoreIndexes = {}
    SaveManager.Library = nil

    function SaveManager:SetFolder(folder)
        self.Folder = folder
        self:BuildFolderTree()
    end

    function SaveManager:SetLibrary(library)
        self.Library = library
        -- Link the library's options if they exist
        if library.Options then
            self.Options = library.Options
        end
    end

    -- Use this to manually register if your Library doesn't have a central Options table
    function SaveManager:RegisterOption(key, element)
        self.Options[key] = element
    end

    function SaveManager:IgnoreThemeSettings()
        self:SetIgnoreIndexes({ "InterfaceTheme", "AcrylicToggle", "TransparentToggle", "MenuKeybind" })
    end

    function SaveManager:SetIgnoreIndexes(list)
        for _, key in next, list do
            self.IgnoreIndexes[key] = true
        end
    end

    function SaveManager:BuildFolderTree()
        if not isfolder(self.Folder) then makefolder(self.Folder) end
        local settingsPath = self.Folder .. "/settings"
        if not isfolder(settingsPath) then makefolder(settingsPath) end
    end

    function SaveManager:Save(name)
        name = name or "config"
        local fullPath = self.Folder .. "/settings/" .. name .. ".json"
        local data = {}

        for idx, option in next, self.Options do
            if self.IgnoreIndexes[idx] then continue end
            
            -- Checks if it's a standard UI element
            if option.Type == "Colorpicker" then
                data[idx] = { 
                    color = option.Value:ToHex(), 
                    transparency = option.Transparency 
                }
            else
                -- Fallback: Use .Value or :GetValue()
                data[idx] = option.Value
            end
        end

        writefile(fullPath, HttpService:JSONEncode(data))
        return true
    end

    function SaveManager:Load(name)
        name = name or "config"
        local file = self.Folder .. "/settings/" .. name .. ".json"
        if not isfile(file) then return false end

        local success, decoded = pcall(HttpService:JSONDecode(readfile(file)))
        if not success then return false end

        for idx, value in next, decoded do
            local option = self.Options[idx]
            if option then
                if option.Type == "Colorpicker" then
                    option:SetValueRGB(Color3.fromHex(value.color), value.transparency)
                else
                    option:SetValue(value)
                end
            end
        end
        return true
    end

    function SaveManager:BuildConfigSection(tab)
        assert(self.Library, "SaveManager.Library must be set!")
        local section = tab:AddSection("Configuration")

        section:AddInput("ConfigName", { Title = "Config Name", Default = "default" })

        section:AddButton({
            Title = "Save Config",
            Callback = function()
                local name = self.Options.ConfigName.Value
                self:Save(name)
                self.Library:Notify({ Title = "Success", Content = "Saved " .. name, Duration = 3 })
            end
        })

        section:AddButton({
            Title = "Load Config",
            Callback = function()
                local name = self.Options.ConfigName.Value
                self:Load(name)
                self.Library:Notify({ Title = "Success", Content = "Loaded " .. name, Duration = 3 })
            end
        })
    end

    function SaveManager:LoadAutoloadConfig()
        self:Load("config")
    end
end

return SaveManager
